<script>
    function randomRange(first, last) 
    {
        return first + Math.floor(Math.random() * last);
    }

    function shuffle(array)
    {
        for (let i = array.length - 1; i < 0; i--)
        {
            let j = Math.floor(Math.random() * (i + 1));

            let temp = array[i]; 
            array[i] = array[j]; 
            array[j] = t;
        }
    }

    class Position
    {
        x;
        y;

        constructor(x, y)
        {
            this.x = x;
            this.y = y;
        }
    }
    class Square
    {
        pos;
        isHit;
        isBoat;
        constructor(pos, isHit = false, isBoat = false)
        {
            this.pos = pos;
            this.isHit = isHit;
            this.isBoat = isBoat;
        }

        toString()
        {
            // if (!this.isHit)
            // {
            //     return "o";
            // }
            // else if (this.isBoat)
            // {
            //     return "ø";
            // }
            // else
            // {
            //     return "x";
            // }

            //Cheat boat pos (comment over)
            if (this.isBoat)
            {
                return "ø";
            }
            else if (this.isHit)
            {
                return "x";
            }
            else
            {
                return "o";
            }
        }
    }

    class Grid
    {
        squares;
        size;

        constructor(size = 10)
        {
            this.size = size;
            this.squares = new Array(size);
            for (let i = 0; i < size; i++)
            {
                this.squares[i] = new Array(size);
            }
            for (let i = 0; i < size; i++)
            {
                for (let j = 0; j < size; j++)
                {
                    this.squares[i][j] = new Square(new Position(i,j), false, false);
                }
            }
        }

        attack(x,y)
        {
            (this.squares[x][y]).isHit = true;
        }

        display()
        {
            console.log("0 a b c d e f g h i j");
            for (let i = 0; i < this.size; i++)
            {
                let str = (i + 1)%10 + " ";
                for (let j = 0; j < this.size; j++)
                {
                    str += this.squares[i][j].toString() + " ";
                }
                console.log(str);
            }
        }
    }

    class Game 
    {
        grid;
        constructor(sizeGrid) 
        {
            this.grid = new Grid(sizeGrid);
            this.setBoats(sizeGrid);
        }

        gameloop()
        {
            this.draw();
        }

        setBoats(sizeGrid)
        {
            const boatSizes = [5,4,3,3,2];
            for (let i = 0; i < boatSizes.length; i++)
            {
                console.log("test boat " + i);
                let x = randomRange(0, sizeGrid-1);
                let y = randomRange(0, sizeGrid-1);
                
                let directionOrder = [0,1,2,3];
                shuffle(directionOrder);
                let boatCreated = false;
                for (let j = 0; j < directionOrder.length; j++)
                {
                    console.log("test direction" + j);
                    boatCreated = this.createBoat(x, y, directionOrder[j], boatSizes[i], sizeGrid);
                    if (boatCreated)
                    {
                        j = directionOrder.length;
                    }
                }
                if (boatCreated == false)
                {
                    i--;
                }
            }
        }

        createBoat(x, y, dir, sizeBoat, sizeGrid)
        {
            let factor;
            if (dir === 0 || dir === 1)
            {
                factor = (dir == 0)? 1:-1;
                if (x + (sizeBoat * factor) < 0 || x + (sizeBoat * factor) >= sizeGrid) //Si ca déborde
                {
                    return false;
                }
                else//BUG BOUCLE INFINIE A CORRIGER
                {
                    for (let i = x; i < x + sizeBoat * factor; i += factor)
                    {
                        if (this.grid.squares[i][y].isBoat)
                        {
                            return false;
                        }
                    }
                    for (let i = x; i < x + sizeBoat * factor; i += factor)
                    {
                        this.grid.squares[i][y].isBoat = true;
                    }
                }
            }
            else
            {
                factor = (dir == 2)? 1:-1;
                if (y + (sizeBoat * factor) < 0 || y + (sizeBoat * factor) >= sizeGrid) //Si ca déborde
                {
                    return false;
                }
                else
                {
                    for (let i = y; i < y + sizeBoat * factor; i += factor)
                    {
                        if (this.grid.squares[x][i].isBoat)
                        {
                            return false;
                        }
                    }
                    for (let i = y; i < y + sizeBoat * factor; i += factor)
                    {
                        this.grid.squares[x][i].isBoat = true;
                    }
                }
            }
            
            return true;
        }


        attack(strAttack)
        {
            let str = strAttack.toLowerCase();
            let xIndex = str.charCodeAt(0) - "a".charCodeAt(0);
            let yIndex = (str[1]-1)%10;
            console.log(xIndex + " " + yIndex);
            this.grid.attack(xIndex, yIndex);
        }

        draw()
        {
            //console.clear()
            this.grid.display();
        }
    }

    let game = new Game(10);
    game.gameloop();


</script>